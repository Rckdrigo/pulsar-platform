name: Security Audit & Performance

on:
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch: # Allow manual triggering

jobs:
  pulsar-security-audit:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./pulsar

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'
          cache-dependency-path: pulsar/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run security audit
        run: npm audit --audit-level=moderate

      - name: Run tests with coverage
        run: npm run test:coverage

  planet-security-audit:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./planet

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'
          cache-dependency-path: planet/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run security audit
        run: npm audit --audit-level=moderate

      - name: Setup test configuration
        run: cp public/config.template.yml public/config.yml

      - name: Run security check script
        run: npm run security-check

  pulsar-dependency-updates:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./pulsar

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache-dependency-path: pulsar/package-lock.json

      - name: Update dependencies
        id: update
        run: |
          # Update to latest patch versions
          npm update

          # Check if there are changes
          if git diff --quiet package-lock.json; then
            echo "No dependency updates available"
            echo "changes=false" >> $GITHUB_OUTPUT
          else
            echo "Dependencies updated"
            echo "changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.update.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update pulsar dependencies'
          title: 'ðŸ”’ Security: Update Pulsar dependencies'
          body: |
            ## Dependency Updates for Pulsar

            This PR contains automated dependency updates for the Pulsar project.

            ### Changes
            - Updated package-lock.json with latest patch versions
            - All updates follow semver patch version updates only

            ### Testing
            - [ ] CI tests pass
            - [ ] Manual testing in development environment
            - [ ] Security audit shows no high/critical vulnerabilities

            ### Security
            This PR was created by the automated security audit workflow.
            Please review the changes and test thoroughly before merging.

            ---

            ðŸ¤– This PR was created automatically by GitHub Actions
          branch: chore/update-pulsar-dependencies
          delete-branch: true
          labels: |
            dependencies
            security

  planet-dependency-updates:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./planet

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache-dependency-path: planet/package-lock.json

      - name: Update dependencies
        id: update
        run: |
          # Update to latest patch versions
          npm update

          # Check if there are changes
          if git diff --quiet package-lock.json; then
            echo "No dependency updates available"
            echo "changes=false" >> $GITHUB_OUTPUT
          else
            echo "Dependencies updated"
            echo "changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.update.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update planet dependencies"
          title: "ðŸ”’ Security: Update Planet dependencies"
          body: |
            ## Dependency Updates for Planet

            This PR contains automated dependency updates for the Planet project.

            ### Changes
            - Updated package-lock.json with latest patch versions
            - All updates follow semver patch version updates only

            ### Testing
            - [ ] CI tests pass
            - [ ] Manual testing in development environment
            - [ ] Security audit shows no high/critical vulnerabilities

            ### Security
            This PR was created by the automated security audit workflow.
            Please review the changes and test thoroughly before merging.

            ---

            ðŸ¤– This PR was created automatically by GitHub Actions
          branch: chore/update-planet-dependencies
          delete-branch: true
          labels: |
            dependencies
            security

  lighthouse-audit:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' # Only run on manual trigger

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create Lighthouse config
        run: |
          cat > .lighthouserc.json << 'EOF'
          {
            "ci": {
              "collect": {
                "numberOfRuns": 3,
                "startServerCommand": "",
                "url": ["https://pulsarinteractive.xyz"]
              },
              "assert": {
                "preset": "lighthouse:recommended",
                "assertions": {
                  "categories:performance": ["error", {"minScore": 0.8}],
                  "categories:accessibility": ["error", {"minScore": 0.9}],
                  "categories:best-practices": ["error", {"minScore": 0.9}],
                  "categories:seo": ["error", {"minScore": 0.9}],
                  "largest-contentful-paint": ["error", {"maxNumericValue": 3000}],
                  "first-contentful-paint": ["error", {"maxNumericValue": 2000}],
                  "cumulative-layout-shift": ["error", {"maxNumericValue": 0.1}]
                }
              },
              "upload": {
                "target": "temporary-public-storage"
              }
            }
          }
          EOF

      - name: Lighthouse CI
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: |
            https://pulsarinteractive.xyz
          configPath: ./.lighthouserc.json
          uploadArtifacts: true
          temporaryPublicStorage: true